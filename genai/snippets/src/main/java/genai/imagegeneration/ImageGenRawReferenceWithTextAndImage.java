/*
 * Copyright 2025 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package genai.imagegeneration;

// [START googlegenaisdk_imggen_raw_reference_with_txt_img]

import com.google.genai.Client;
import com.google.genai.types.EditImageConfig;
import com.google.genai.types.EditImageResponse;
import com.google.genai.types.GeneratedImage;
import com.google.genai.types.Image;
import com.google.genai.types.RawReferenceImage;
import java.util.List;
import java.util.Optional;

public class ImageGenRawReferenceWithTextAndImage {

  public static void main(String[] args) {
    // TODO(developer): Replace these variables before running the sample.
    String modelId = "imagen-3.0-capability-001";
    String outputGcsUri = "gs://your-bucket/your-prefix";
    styleTransferCustomization(modelId, outputGcsUri);
  }

  /**
   * Generates an image in a new style based on a raw reference image and text prompt.
   *
   * <p>This function demonstrates style transfer customization. It uses a raw reference image of a
   * "teacup". The model is instructed to recreate the reference image in a new style based on the
   * text prompt.
   *
   * @param modelId The GenAI model to use for generating the image.
   * @param outputGcsUri A GCS URI where the generated image will be saved. Example:
   *     "gs://your-bucket/your-prefix"
   * @return An Optional containing the GCS URI of the generated image if successful.
   */
  public static Optional<String> styleTransferCustomization(String modelId, String outputGcsUri) {
    // Client Initialization. Once created, it can be reused for multiple requests.
    try (Client client = Client.builder().location("global").vertexAI(true).build()) {
      // Create a raw reference image of teacup stored in Google Cloud Storage
      // using https://storage.googleapis.com/cloud-samples-data/generative-ai/image/teacup-1.png
      RawReferenceImage rawReferenceImage =
          RawReferenceImage.builder()
              .referenceId(1)
              .referenceImage(
                  Image.builder()
                      .gcsUri("gs://cloud-samples-data/generative-ai/image/teacup-1.png")
                      .build())
              .build();

      // The `[1]` in the prompt refers to the `referenceId` assigned to the raw reference image.
      EditImageResponse imageResponse =
          client.models.editImage(
              modelId,
              "transform the subject in the image so that "
                  + "the teacup[1] is made entirely out of chocolate",
              List.of(rawReferenceImage),
              EditImageConfig.builder()
                  .editMode("EDIT_MODE_DEFAULT")
                  .numberOfImages(1)
                  .safetyFilterLevel("BLOCK_MEDIUM_AND_ABOVE")
                  .personGeneration("ALLOW_ADULT")
                  .outputGcsUri(outputGcsUri)
                  .build());

      Image generatedImage =
          imageResponse
              .generatedImages()
              .flatMap(generatedImages -> generatedImages.stream().findFirst())
              .flatMap(GeneratedImage::image)
              .orElseThrow(() -> new IllegalStateException("No image was generated by the model."));

      generatedImage.gcsUri().ifPresent(System.out::println);
      // Example response:
      // gs://your-bucket/your-prefix
      return generatedImage.gcsUri();
    }
  }
}
// [END googlegenaisdk_imggen_raw_reference_with_txt_img]
